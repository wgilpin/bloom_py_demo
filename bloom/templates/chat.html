{% extends "base.html" %}

{% block title %}Chat - {{ subtopic_name }} | Bloom{% endblock %}

{% block header_actions %}
<div class="flex items-center space-x-4">
    <span class="text-sm text-gray-600">Studying: <span class="font-semibold">{{ subtopic_name }}</span></span>
    <button 
        onclick="startNewChat()"
        class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700 transition-colors"
    >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        New Chat
    </button>
    <a href="/" class="text-sm text-blue-600 hover:text-blue-800">‚Üê Back to Syllabus</a>
</div>

<script>
function startNewChat() {
    if (confirm('End this session and start a new topic?\n\nYour progress will be saved.')) {
        // Abandon ALL active sessions (empty body = abandon all)
        fetch('/session/abandon', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: ''
        }).then(() => {
            window.location.href = '/';
        });
    }
}

// Whiteboard Image Progressive Loading (spec 003)
// This loads images after text displays, with polling for first-time generation
document.addEventListener('DOMContentLoaded', function() {
    loadWhiteboardImages();
});

// Also trigger on htmx afterSwap (when messages update)
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'chat-messages') {
        loadWhiteboardImages();
    }
});

function loadWhiteboardImages() {
    // Find all image containers with subtopic_id
    const containers = document.querySelectorAll('.whiteboard-image-container[data-subtopic-id]');
    
    containers.forEach(container => {
        // Skip if already loaded
        if (container.querySelector('img')) {
            return;
        }
        
        const subtopicId = container.dataset.subtopicId;
        const loadingSpinner = container.querySelector('.image-loading');
        
        // Attempt to load image (with polling for generation)
        attemptImageLoad(subtopicId, container, loadingSpinner, 0);
    });
}

function attemptImageLoad(subtopicId, container, loadingSpinner, attemptCount) {
    const maxAttempts = 30; // 30 seconds (1 second intervals)
    const pollInterval = 1000; // 1 second
    
    fetch(`/api/image/${subtopicId}`)
        .then(response => {
            if (response.ok) {
                // Image found - display it
                return response.blob();
            } else if (response.status === 404) {
                // Image not found yet
                if (attemptCount < maxAttempts) {
                    // Retry after interval (image may still be generating)
                    setTimeout(() => {
                        attemptImageLoad(subtopicId, container, loadingSpinner, attemptCount + 1);
                    }, pollInterval);
                } else {
                    // Timeout - hide spinner gracefully (no error shown)
                    if (loadingSpinner) {
                        loadingSpinner.style.display = 'none';
                    }
                }
                return null;
            } else {
                // Other error - hide spinner gracefully
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
                return null;
            }
        })
        .then(blob => {
            if (blob) {
                // Create and display image
                const imageUrl = URL.createObjectURL(blob);
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = 'Whiteboard diagram explaining the concept';
                img.className = 'whiteboard-image rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow';
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                
                // Click to expand functionality
                img.addEventListener('click', () => openImageModal(imageUrl));
                
                // Hide loading spinner
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
                
                // Add image to container
                container.appendChild(img);
            }
        })
        .catch(error => {
            // Network error - hide spinner gracefully (no error to user)
            console.debug('Image load error:', error);
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
            }
        });
}

function openImageModal(imageUrl) {
    // Create modal overlay
    const modal = document.createElement('div');
    modal.className = 'image-modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
    modal.style.cursor = 'zoom-out';
    
    // Create expanded image
    const img = document.createElement('img');
    img.src = imageUrl;
    img.className = 'max-w-full max-h-full rounded-lg shadow-2xl';
    img.style.cursor = 'zoom-out';
    
    modal.appendChild(img);
    document.body.appendChild(modal);
    
    // Close on click
    modal.addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    // Close on escape key
    const escapeHandler = (e) => {
        if (e.key === 'Escape') {
            if (document.body.contains(modal)) {
                document.body.removeChild(modal);
            }
            document.removeEventListener('keydown', escapeHandler);
        }
    };
    document.addEventListener('keydown', escapeHandler);
}
</script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Chat Container -->
    <div class="bg-white rounded-lg shadow-lg border border-gray-200 flex flex-col h-[calc(100vh-12rem)]">
        
        <!-- Chat Header -->
        <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
            <h2 class="text-xl font-semibold text-gray-900">{{ subtopic_name }}</h2>
            <p class="text-sm text-gray-600 mt-1">Your AI tutor is here to help you learn!</p>
        </div>
        
        <!-- Messages Container -->
        <div 
            id="chat-messages" 
            class="flex-1 overflow-y-auto p-6 space-y-4 chat-scroll"
            hx-get="/chat/messages?session_id={{ session_id }}"
            hx-trigger="load"
            hx-swap="innerHTML"
            hx-indicator="#loading-indicator"
        >
            <!-- Messages will be loaded here via htmx -->
            <div id="loading-indicator" class="text-center py-12">
                <div class="inline-flex items-center space-x-3 bg-blue-50 px-6 py-4 rounded-lg border border-blue-200">
                    <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <div class="text-left">
                        <p class="text-sm font-semibold text-blue-900">Loading your lesson...</p>
                        <p class="text-xs text-blue-600 mt-1">Bloom is preparing your personalized explanation</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Calculator (conditionally visible) -->
        {% if calculator_visible %}
        <div id="calculator-container" class="px-6 py-4 border-t border-gray-200 bg-gray-50">
            <div class="max-w-sm mx-auto">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-right mb-3">
                        <input 
                            type="text" 
                            id="calc-display" 
                            readonly 
                            value="0"
                            class="w-full px-4 py-3 text-2xl font-mono text-right bg-gray-100 rounded border border-gray-300"
                        >
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <!-- Calculator buttons -->
                        <button class="calc-btn-clear" onclick="calcClear()">C</button>
                        <button class="calc-btn-operator" onclick="calcAppend('/')">/</button>
                        <button class="calc-btn-operator" onclick="calcAppend('*')">√ó</button>
                        <button class="calc-btn-operator" onclick="calcAppend('-')">-</button>
                        
                        <button class="calc-btn-number" onclick="calcAppend('7')">7</button>
                        <button class="calc-btn-number" onclick="calcAppend('8')">8</button>
                        <button class="calc-btn-number" onclick="calcAppend('9')">9</button>
                        <button class="calc-btn-operator" onclick="calcAppend('+')">+</button>
                        
                        <button class="calc-btn-number" onclick="calcAppend('4')">4</button>
                        <button class="calc-btn-number" onclick="calcAppend('5')">5</button>
                        <button class="calc-btn-number" onclick="calcAppend('6')">6</button>
                        <button class="calc-btn-operator" onclick="calcAppend('(')">(</button>
                        
                        <button class="calc-btn-number" onclick="calcAppend('1')">1</button>
                        <button class="calc-btn-number" onclick="calcAppend('2')">2</button>
                        <button class="calc-btn-number" onclick="calcAppend('3')">3</button>
                        <button class="calc-btn-operator" onclick="calcAppend(')')">)</button>
                        
                        <button class="calc-btn-number" onclick="calcAppend('0')">0</button>
                        <button class="calc-btn-number" onclick="calcAppend('.')">.</button>
                        <button class="calc-btn-equals col-span-2" onclick="calcEvaluate()">=</button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 text-center mt-2">Calculator is available for this question</p>
            </div>
        </div>
        {% endif %}
        
        <!-- Message Input Form -->
        <div class="px-6 py-4 border-t border-gray-200 bg-white">
            <form 
                hx-post="/chat/message"
                hx-target="#chat-messages"
                hx-swap="beforeend"
                hx-on::after-request="document.getElementById('message-input').value = ''; scrollToBottom();"
                class="flex space-x-3"
            >
                <input type="hidden" name="session_id" value="{{ session_id }}">
                <input 
                    type="text" 
                    id="message-input"
                    name="message" 
                    placeholder="Type your answer or question..."
                    required
                    autocomplete="off"
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                <button 
                    type="submit"
                    class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    Send
                </button>
            </form>
            
            <!-- Retry button (hidden by default, shown on error) -->
            <div id="retry-container" class="mt-2 hidden">
                <button 
                    hx-post="/chat/retry"
                    hx-vals='{"session_id": {{ session_id }}}'
                    hx-target="#chat-messages"
                    hx-swap="beforeend"
                    class="text-sm text-blue-600 hover:text-blue-800"
                >
                    üîÑ Retry last message
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Auto-scroll to bottom of chat
    function scrollToBottom() {
        const container = document.getElementById('chat-messages');
        container.scrollTop = container.scrollHeight;
    }
    
    // Typeset math content when messages are loaded
    function typeset() {
        if (window.MathJax && MathJax.typesetPromise) {
            MathJax.typesetPromise().catch((err) => console.log('MathJax typeset error:', err));
        }
    }
    
    // Scroll on initial load
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            scrollToBottom();
            typeset();
        }, 100);
    });
    
    // Re-typeset math after htmx swaps
    document.body.addEventListener('htmx:afterSwap', (event) => {
        typeset();
        scrollToBottom();
    });
    
    // Calculator functions
    let calcExpression = '';
    
    function calcAppend(value) {
        if (calcExpression === '0' || calcExpression === 'Error') {
            calcExpression = value;
        } else {
            calcExpression += value;
        }
        document.getElementById('calc-display').value = calcExpression;
    }
    
    function calcClear() {
        calcExpression = '0';
        document.getElementById('calc-display').value = calcExpression;
    }
    
    function calcEvaluate() {
        try {
            // Sanitize input (only allow numbers and basic operators)
            const sanitized = calcExpression.replace(/[^0-9+\-*/.()]/g, '');
            
            // Evaluate (note: eval is safe here because we sanitized input)
            const result = eval(sanitized);
            
            calcExpression = result.toString();
            document.getElementById('calc-display').value = calcExpression;
            
            // TODO: Log calculation to server
            // This would be sent via htmx to /calculator/log endpoint
        } catch (e) {
            calcExpression = 'Error';
            document.getElementById('calc-display').value = 'Error';
        }
    }
</script>
{% endblock %}

